# Web3 User Authentication Service

ä¸€ä¸ªåŸºäºSolanaåŒºå—é“¾çš„Web3ç”¨æˆ·è®¤è¯æœåŠ¡ï¼Œæä¾›å®‰å…¨çš„ç”¨æˆ·èº«ä»½éªŒè¯å’Œä»¤ç‰Œç®¡ç†åŠŸèƒ½ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- **å®‰å…¨è®¤è¯**: åŸºäºSolanaé’±åŒ…åœ°å€å’Œæ•°å­—ç­¾åçš„èº«ä»½éªŒè¯
- **ä»¤ç‰Œç®¡ç†**: AES-256-CBCåŠ å¯†çš„ç”¨æˆ·ä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯
- **ä½™é¢éªŒè¯**: å¯é…ç½®çš„æœ€å°ä½™é¢è¦æ±‚
- **å®‰å…¨é˜²æŠ¤**: é›†æˆäº†é€Ÿç‡é™åˆ¶ã€CORSã€Helmetç­‰å®‰å…¨ä¸­é—´ä»¶
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼å’Œè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- **æ€§èƒ½ç›‘æ§**: è¯·æ±‚æ—¥å¿—è®°å½•å’Œå“åº”æ—¶é—´ç›‘æ§

## ğŸ“‹ API ç«¯ç‚¹

### 1. å¥åº·æ£€æŸ¥
```
GET /health
```
è¿”å›æœåŠ¡çŠ¶æ€å’Œè¿è¡Œæ—¶é—´ä¿¡æ¯ã€‚

### 2. è·å–ç”¨æˆ·ID
```
POST /getUserId
Content-Type: application/json

{
  "address": "solana_wallet_address"
}
```

### 3. è·å–ç”¨æˆ·ä»¤ç‰Œ
```
POST /getUserToken
Content-Type: application/json

{
  "address": "solana_wallet_address",
  "signature": "base58_encoded_signature",
  "uid": "user_id_from_step_2"
}
```

### 4. é€šè¿‡ Memo è·å–ç”¨æˆ·ä»¤ç‰Œ
```
POST /getUserTokenByMemo
Content-Type: application/json

{
  "address": "solana_wallet_address",
  "uid": "user_id_from_step_2",
  "transaction": "base58_signed_transaction_with_memo_equal_uid"
}
```

- è¯·æ±‚å‚æ•°è¯´æ˜
  - `address`: ç”¨æˆ·çš„ Solana é’±åŒ…åœ°å€ï¼ˆbase58 å­—ç¬¦ä¸²ï¼‰
  - `uid`: é€šè¿‡ `/getUserId` è·å–çš„ç”¨æˆ· ID
  - `transaction`: å·²ç­¾åä¸”åºåˆ—åŒ–ä¸º base58 çš„äº¤æ˜“å­—ç¬¦ä¸²ï¼Œäº¤æ˜“å†…éœ€åŒ…å« Memo æŒ‡ä»¤ï¼Œå…¶å†…å®¹å¿…é¡»ä¸¥æ ¼ç­‰äº `uid`

- å“åº”ç¤ºä¾‹
```
200 OK
{
  "result": "encrypted_token"
}
```

- æ ¡éªŒè§„åˆ™
  - éªŒè¯äº¤æ˜“ä¸­ç­¾åè€…åˆ—è¡¨åŒ…å« `address`
  - è§£æäº¤æ˜“ä¸­çš„ Memo æŒ‡ä»¤å¹¶æ ¡éªŒå…¶ UTF-8 å†…å®¹ç­‰äº `uid`
  - äº¤æ˜“å¿…é¡»æ˜¯å·²ç­¾åçš„ base58 åºåˆ—åŒ–å­—ç¬¦ä¸²
  - ä½¿ç”¨é…ç½®çš„é›†ç¾¤ï¼ˆ`CLUSTER`ï¼‰ï¼Œåœ¨æœåŠ¡å™¨ç«¯å®Œæˆè§£æä¸éªŒè¯

- å¯èƒ½çš„é”™è¯¯
  - `400 Invalid address`ï¼šåœ°å€æ ¼å¼ä¸åˆæ³•
  - `400 Invalid uid`ï¼šuid ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯
  - `400 Invalid transaction`ï¼šäº¤æ˜“æ— æ³•è§£ææˆ–éå·²ç­¾åäº¤æ˜“
  - `400 Signature not found`ï¼šäº¤æ˜“ä¸åŒ…å«è¯¥åœ°å€çš„æœ‰æ•ˆç­¾å
  - `400 Memo mismatch`ï¼šäº¤æ˜“ä¸­çš„ Memo å†…å®¹ä¸ç­‰äº `uid`
  - `429 Too Many Requests`ï¼šè§¦å‘é€Ÿç‡é™åˆ¶
  - `500 Internal Server Error`ï¼šæœåŠ¡å™¨å†…éƒ¨é”™è¯¯

- ä½¿ç”¨ç¤ºä¾‹
```bash
# 1) è·å– UID
curl -s -X POST 'http://127.0.0.1:4000/getUserId' \
  -H 'Content-Type: application/json' \
  -d '{"address":"<YOUR_ADDRESS>"}'

# 2) ä½¿ç”¨ Ledger ç”ŸæˆåŒ…å« UID çš„ Memo äº¤æ˜“å¹¶ç­¾åï¼ˆä¸¤ç§æ–¹å¼ï¼‰
# æ–¹å¼ Aï¼šäº¤äº’å¼å·¥å…·
node solana/ledger/sign-memo.js "<UID>"

# æ–¹å¼ Bï¼šä¸€é”®æµ‹è¯•ç¨‹åº
cd solana/ledger && ./run-test.sh

# 3) è°ƒç”¨ Memo æ¥å£è·å– Token
curl -s -X POST 'http://127.0.0.1:4000/getUserTokenByMemo' \
  -H 'Content-Type: application/json' \
  -d '{"address":"<YOUR_ADDRESS>","uid":"<UID>","transaction":"<BASE58_TX>"}'
```

### 5. éªŒè¯ç”¨æˆ·ä»¤ç‰Œ
```
POST /checkUserToken
Content-Type: application/json

{
  "token": "encrypted_token"
}

# æˆ–è€…ä½¿ç”¨ GET è¯·æ±‚
GET /checkUserToken
token: encrypted_token
```

## ğŸ› ï¸ å®‰è£…å’Œé…ç½®

### 1. å®‰è£…ä¾èµ–
```bash
cd solana
npm install
```

### 2. ç¯å¢ƒé…ç½®
å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿å¹¶é…ç½®ï¼š
```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œé…ç½®ä»¥ä¸‹å¿…éœ€çš„ç¯å¢ƒå˜é‡ï¼š

```env
# æœåŠ¡å™¨ç«¯å£
PORT=4000

# åŠ å¯†ç›å€¼
SALT=your_random_salt_here

# AES-256-CBC åŠ å¯†å¯†é’¥ (32å­—èŠ‚åå…­è¿›åˆ¶)
KEY=your_32_byte_hex_key_here

# AES-256-CBC åˆå§‹åŒ–å‘é‡ (16å­—èŠ‚åå…­è¿›åˆ¶)
IV=your_16_byte_hex_iv_here

# Solana é›†ç¾¤ URL
CLUSTER=https://api.devnet.solana.com

# æœ€å°ä½™é¢è¦æ±‚ (LAMPORTS)
MIN_BALANCE=1000000

# CORS å…è®¸çš„æº (é€—å·åˆ†éš”)
ALLOWED_ORIGINS=http://localhost:4000
```

### 3. ç”ŸæˆåŠ å¯†å¯†é’¥
ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆå®‰å…¨çš„å¯†é’¥ï¼š

```bash
# ç”Ÿæˆ AES å¯†é’¥
node -e "console.log('KEY=' + require('crypto').randomBytes(32).toString('hex'))"

# ç”Ÿæˆåˆå§‹åŒ–å‘é‡
node -e "console.log('IV=' + require('crypto').randomBytes(16).toString('hex'))"
```

### 4. å¯åŠ¨æœåŠ¡
```bash
# ç”Ÿäº§ç¯å¢ƒ
npm start

# å¼€å‘ç¯å¢ƒ (è‡ªåŠ¨é‡å¯)
npm run dev
```

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- **é€Ÿç‡é™åˆ¶**: æ¯15åˆ†é’Ÿæœ€å¤š100ä¸ªè¯·æ±‚
- **CORSä¿æŠ¤**: å¯é…ç½®çš„è·¨åŸŸèµ„æºå…±äº«
- **Helmetå®‰å…¨å¤´**: è‡ªåŠ¨è®¾ç½®å®‰å…¨HTTPå¤´
- **è¾“å…¥éªŒè¯**: ä¸¥æ ¼çš„å‚æ•°éªŒè¯å’Œç±»å‹æ£€æŸ¥
- **é”™è¯¯å¤„ç†**: å®‰å…¨çš„é”™è¯¯ä¿¡æ¯ï¼Œä¸æ³„éœ²æ•æ„Ÿæ•°æ®
- **ç¯å¢ƒå˜é‡éªŒè¯**: å¯åŠ¨æ—¶æ£€æŸ¥å¿…éœ€çš„é…ç½®é¡¹

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

æœåŠ¡æä¾›ä»¥ä¸‹ç›‘æ§åŠŸèƒ½ï¼š

- **è¯·æ±‚æ—¥å¿—**: è®°å½•æ‰€æœ‰HTTPè¯·æ±‚çš„æ–¹æ³•ã€è·¯å¾„ã€çŠ¶æ€ç å’Œå“åº”æ—¶é—´
- **é”™è¯¯æ—¥å¿—**: è¯¦ç»†çš„é”™è¯¯å †æ ˆè·Ÿè¸ª
- **æ€§èƒ½æŒ‡æ ‡**: å“åº”æ—¶é—´ç›‘æ§
- **å¥åº·æ£€æŸ¥**: æœåŠ¡çŠ¶æ€å’Œè¿è¡Œæ—¶é—´

## ğŸ”§ å¼€å‘è¯´æ˜

### ä»£ç ç»“æ„
- ä½¿ç”¨ES6æ¨¡å—ç³»ç»Ÿ
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- ä¸­é—´ä»¶åŒ–çš„è¾“å…¥éªŒè¯
- æ¨¡å—åŒ–çš„å·¥å…·å‡½æ•°

### ä¸»è¦ä¼˜åŒ–
1. **ä»£ç ç»“æ„**: ç§»é™¤TypeScriptç¼–è¯‘ä»£ç ï¼Œä½¿ç”¨åŸç”ŸES6æ¨¡å—
2. **é”™è¯¯å¤„ç†**: ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼ï¼Œæ”¹è¿›é”™è¯¯ä¿¡æ¯
3. **å®‰å…¨æ€§**: æ·»åŠ å¤šå±‚å®‰å…¨é˜²æŠ¤
4. **æ€§èƒ½**: ä¼˜åŒ–ä»£ç é‡å¤ï¼Œæå‡æ‰§è¡Œæ•ˆç‡
5. **ç›‘æ§**: æ·»åŠ è¯·æ±‚æ—¥å¿—å’Œæ€§èƒ½ç›‘æ§

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§ç¯å¢ƒ**: ç¡®ä¿ä½¿ç”¨å¼ºéšæœºå¯†é’¥å’Œå®‰å…¨çš„ç¯å¢ƒå˜é‡
2. **ç½‘ç»œå®‰å…¨**: åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é…ç½®é€‚å½“çš„CORSç­–ç•¥
3. **å¯†é’¥ç®¡ç†**: å®šæœŸè½®æ¢åŠ å¯†å¯†é’¥
4. **ç›‘æ§**: è®¾ç½®é€‚å½“çš„æ—¥å¿—çº§åˆ«å’Œç›‘æ§å‘Šè­¦

## ğŸ“ è®¸å¯è¯

MIT License
